@page "/tarefas"
@page "/tarefas/{status}"
@page "/lista"
@rendermode InteractiveServer

@inject NavigationManager Nav

<button class="btn btn-link mb-3" @onclick="IrParaResumo">
    <i class="bi bi-bar-chart-line"></i>
    Ver resumo
</button>

<h1>Lista de tarefas</h1>
<h5>Usando <b>rendermode InteractiveServer</b></h5>
<br/>

<div class="alert alert-primary mt-4 p-3" style="border-left: 5px solid #0d6efd">
    <h5 class="alert-heading fw-bold">Diagnóstico de Renderização</h5>
    <hr />
    <dl class="row">
        <dt class="col-sm-4">Local de Execução: </dt>
        @****************************************************************************************************@
        @* Retorna o local de execução do componente:                                                       *@
        @* - Static (Renderização estática no servidor (SSR), sem capacidade de interatividade              *@
        @* - Server (Renderização no servidor, mas como parte de um circuito interativo (InteractiveServer) *@
        @* - WebAssembly (Renderização no cliente, dentro do runtime do WebAssembly (InteractiveWebAssembly)*@
        @****************************************************************************************************@
        <dd class="col-sm-8"><code>@RendererInfo.Name</code></dd>
        <dt class="col-sm-4">É interativo (agora): </dt>
        @*******************************************************************@
        @* Retorna se o componente está interativo no momento *@
        @*******************************************************************@
        <dd class="col-sm-8"><code>@RendererInfo.IsInteractive</code></dd>

        <dt class="col-sm-4">Modo Atribuído: </dt>
        @********************************************************************@
        @* Retorna o modo de renderização atribuído ao componente:          *@
        @*  - InteractiveWebAssembly                                        *@
        @*  - InteractiveServer                                             *@
        @*  - InteractiveAuto                                               *@
        @********************************************************************@
        <dd class="col-sm-8"><code>@(AssignedRenderMode?.GetType().Name ?? "Nenhum (Estático/SSR)")</code></dd>
    </dl>
</div>

@if(RendererInfo?.Name == "Static")
{
    <p>Este componente foi renderizado estaticamente e não é interativo</p>
}
else if(RendererInfo?.IsInteractive == true)
{
    <p>Este componente foi renderizado no @RendererInfo?.Name, agora é interativo</p>
}

@if(tarefas == null)
{
    <p>Carregando dados...</p>
}
else if (!tarefas.Any())
{
    <p>Ainda não existem tarefas...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Ação</th>
                <th>Data</th>
                <th>Descrição</th>
                <th>Concluída</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in tarefas)
            {
                <tr>
                    <td>
                        <button class="btn btn-danger btn-sm" @onclick="() => RemoverTarefa(item.ID)">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                    <td>@item.DataCriacao.ToShortDateString()</td>
                    <td>@item.Descricao</td>
                    <td>
                        <input type="checkbox" style="cursor: pointer" checked="@item.Concluida" @onchange="() => AlternarConclusao(item.ID)" />
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {

    // Parâmetro de rota 
    [Parameter]
    public string? Status { get; set; }

    private List<Tarefa>? tarefas;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(2000); 
        var todas = TarefaDados.ObterTarefas();

        tarefas = Status?.ToLower() switch
        {
            "concluidas" => todas.Where(t => t.Concluida).ToList(),
            "pendentes" => todas.Where(t => !t.Concluida).ToList(),
            _ => todas
        };
    }

    /// <summary>
    /// Remove a tarefa com o ID especificado.
    /// </summary>
    /// <param name="id"></param>
    private void RemoverTarefa(Guid id) => tarefas?.RemoveAll(t => t.ID == id);

    /// <summary>
    /// Ao alternar a conclusão da tarefa, atualiza o status de conclusão.
    /// </summary>
    /// <param name="id"></param>
    private void AlternarConclusao(Guid id)
    {
        var tarefa = tarefas?.FirstOrDefault(t => t.ID == id);

        if (tarefa != null)
            tarefa.Concluida = !tarefa.Concluida;
    }

    private void IrParaResumo() => Nav.NavigateTo("/tarefas-resumo");
}
